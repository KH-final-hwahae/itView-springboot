<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="itView.springboot.mapper.AdminMapper">
<!-- 회원 전체 조회-->
<select id="getUserListCount" resultType="int">
select count(*) 
    from (
        select u.user_no, u.user_id, u.email, u.user_type, u.brand_name, u.user_status,
               count(r.report_no) as reportCount
        from "USER" u
        left join REPORT r on u.user_no = r.reporter_user_id
        group by u.user_no, u.user_id, u.email, u.user_type, u.brand_name, u.user_status)t
	<if test="value != null and value != ''">
		<choose>
			<when test="condition == 'userId'">
				where user_id like '%' || #{value} || '%'
			</when>
			<when test="condition == 'userType'">
				where user_type like '%'|| #{value} ||'%'
			</when>
			<when test="condition == 'userStatus'">
				where user_status like '%' || #{value} || '%'
			</when>
			<when test="condition == 'reportCount'">
				where reportCount = #{value}
			</when>
			<otherwise>
            	where (user_id like '%' || #{value} || '%')
            </otherwise>
		</choose>
	</if>
</select>

<select id="selectUserList" resultType="itView.springboot.dto.UserReport">
	select * 
    from (
        select 
        	u.user_no, u.user_id, u.email, u.user_type, 
        	u.brand_name, u.user_status,
               count(r.report_no) as reportCount
        from "USER" u
        left join REPORT r 
        	on u.user_no = r.reporter_user_id
        	and r.report_type = 'U'
        group by 
        	u.user_no, u.user_id, u.email, u.user_type, u.brand_name, u.user_status)t
	<if test="value != null and value != ''">
		<choose>
			<when test="condition == 'userId'">
				where upper(user_id) like '%' || upper(#{value}) || '%'
			</when>
			<when test="condition == 'userType'">
				where upper(user_type) like '%'|| upper(#{value})||'%'
			</when>
			<when test="condition == 'userStatus'">
				where upper(user_status) like '%' || upper(#{value}) || '%'
			</when>
			<when test="condition == 'reportCount'">
				where reportCount = #{value}
			</when>
			<otherwise>
            	where (upper(user_id) like '%' || upper(#{value}) || '%')
            </otherwise>
		</choose>
	</if>
</select>

<select id="selectUser" parameterType="int" resultType="itView.springboot.dto.UserReport">
SELECT 
    u.user_no,
    u.user_id,
    u.email,
    u.user_type,
    u.brand_name,
    u.user_status,
    COUNT(r.report_no) AS reportCount
FROM "USER" u
LEFT JOIN REPORT r 
    ON u.user_no = r.reporter_user_id
    AND r.report_type = 'U'
WHERE u.user_no = #{userNo}
GROUP BY 
    u.user_no, u.user_id, u.email, u.user_type, u.brand_name, u.user_status;
</select>


<!-- 신고게시판 조회 -->
<select id="getReportListCount" resultType="int">
select count(*) 
    from (
    	select report_target_no
    	from report r
    	left join "USER" u
            on r.reporter_user_id = u.user_no
    	where report_type !='P'
    	)
   
	 <if test="value != null and value != ''">
		<choose>
			<when test="condition == 'reportTitle'">
				and upper(r.report_title) like '%' || upper(#{value}) || '%'
			</when>
			<when test="condition == 'userName'">
				and upper(r.user_name) like '%'|| upper(#{value}) ||'%'
			</when>
			<when test="condition == 'reportType'">
				and upper(r.report_type) = upper(#{value}) 
			</when>
			<when test="condition == 'reportStatus'">
				and upper(r.report_status) = #{value}
			</when>
	  </choose>
	</if>
</select>

<select id="selectReportUserList">
	SELECT 
	    ROW_NUMBER() OVER (ORDER BY COUNT(report_no) DESC) AS row_num,
	    report_type,
	    user_no,
	    user_name,
	    COUNT(report_no) AS report_count
		FROM "USER"
		JOIN report
		  ON report_target_no = user_no
		WHERE report_type = 'U'
		GROUP BY user_no, user_name, report_type
		ORDER BY report_count DESC
</select>
<select id="selectReportBoardList" >
	SELECT 
	    ROW_NUMBER() OVER (ORDER BY COUNT(report_no) DESC) AS row_num,
	    report_type,
	    board_id,
	    board_title,
	    COUNT(report_no) AS report_count
		FROM board b
		JOIN report r
		  ON r.report_target_no = b.board_id
		WHERE report_type = 'B'
		GROUP BY  r.report_type, b.board_id, b.board_title
		ORDER BY report_count DESC
</select>
	
<select id="selectReportReviewList" >
	SELECT 
	    ROW_NUMBER() OVER (ORDER BY COUNT(report_no) DESC) AS row_num,
	    report_type,
	    review_no,
	    COUNT(report_no) AS report_count
		FROM review
		JOIN report
		  ON report_target_no = review_no
		WHERE report_type = 'R'
		GROUP BY review_no, report_type
		ORDER BY report_count DESC
</select>

<select id="selectReportReplyList">
	SELECT 
	    ROW_NUMBER() OVER (ORDER BY COUNT(report_no) DESC) AS row_num,
	    report_type,
	    reply_no,
	    COUNT(report_no) AS report_count
		FROM reply
		JOIN report
		  ON report_target_no = reply_no
		WHERE report_type = 'P'
		GROUP BY reply_no, report_type
		ORDER BY report_count DESC
</select>


<!-- 신고 상세조회 -->
<select id="selectReportDetail" parameterType="int" resultType="itView.springboot.dto.ReportDetail">
	select * 
	from report 
	where report_no = #{reportNo}
</select>


<!-- 일반 문의 게시판 조회 -->
<select id="gBoardListCount" parameterType="int" resultType="java.lang.Integer">
	select count(*) from board where board_type = '3' and board_status = 'Y'
</select>
<select id="selectBoardList" resultType="Board">
	select 
		b.board_id,
		b.board_title,
		b.board_content,
		b.board_date,
		b.board_modified_date,
		b.board_type,
		b.board_status,
		b.user_no,
		b.board_reply_status,
		u.user_id
	from board b
	join
		"USER" u 
		 on b.user_no = u.user_no
	where board_type='3' and board_status ='Y'
</select>

<select id="gBoardDetail" parameterType="int" resultType="itView.springboot.dto.GboardDetail">
select 
		b.board_id,
		b.board_title,
		b.board_content,
		b.board_date,
		b.board_modified_date,
		b.board_type,
		b.board_status,
		b.user_no,
		b.board_reply_status,
		u.user_id
from board b
join "USER" u 
 	  on b.user_no = u.user_no
where board_id = #{boardId} and board_status='Y' and board_type='3'
order by board_date desc, board_id DESC
</select>

<!-- 일반문의게시판 답변등록 -->
<insert id="saveGreply">
	insert into admin_reply
	values (ㅡ
		seq_admin_reply.nextval,
		#{replyContent},
		sysdate,
		sysdate,
		'Y',
		#{boardId},
		'3',
		#{userNo}
		)
</insert>

<!-- 일반문의 댓글조회-->
<select id="getGeneralReplyList" parameterType="int" resultType="AdminReply">
	select * from admin_reply 
	where board_type='3' 
		and reply_status ='Y' 
		and board_id = #{boardId}
	order by reply_date desc
</select>


<!-- 판매자 문의게시판 조회하기 -->
<select id="pBoardListCount" parameterType="int" resultType="java.lang.Integer">
	select count(*) from board where board_type = '3' and board_status = 'Y'
</select>
<select id="selectpBoardList" resultType="Board">
	select 
		b.board_id,
		b.board_title,
		b.board_content,
		b.board_date,
		b.board_modified_date,
		b.board_type,
		b.board_status,
		b.user_no,
		b.board_reply_status,
		u.brand_name
	from board b
	join
		"USER" u 
		 on b.user_no = u.user_no
	where board_type='7' and board_status ='Y'
</select>

<!-- 판매금지 제품 조회 -->
<select id="getproListCount" parameterType="int" resultType="java.lang.Integer">
SELECT COUNT(*)
    FROM BOARD b
    JOIN PRODUCT p ON b.USER_NO = p.USER_NO
    <where>
    	b.BOARD_STATUS = 'Y' AND BOARD_TYPE='8'
        <if test="value != null and value != ''">
            <choose>
                <when test="condition == 'productName'">
                    AND UPPER(p.PRODUCT_NAME) LIKE '%' || UPPER(#{value}) || '%'
                </when>
                <when test="condition == 'productCompany'">
                    AND UPPER(p.PRODUCT_COMPANY) LIKE '%' || UPPER(#{value}) || '%'
                </when>
                <when test="condition == 'boardDate'">
                    AND TO_CHAR(b.BOARD_DATE, 'YYYY-MM-DD') = #{value}
                </when>
                <otherwise>
                    AND (UPPER(p.PRODUCT_NAME) LIKE '%' || UPPER(#{value}) || '%')
                </otherwise>
            </choose>
        </if>
    </where>
</select>

<select id="selecProhibitList" resultType="Board">
SELECT *
    FROM BOARD b
    <where>
    	BOARD_STATUS = 'Y'AND BOARD_TYPE='8'
        <if test="value != null and value != ''">
            <choose>
                <when test="condition == 'boardTitle'">
                    AND UPPER(board_title) LIKE '%' || UPPER(#{value}) || '%'
                </when>
                <when test="condition == 'boardNo'">
                    AND board_id LIKE '%' || #{value} || '%'
                </when>
                <when test="condition == 'boardDate'">
                    AND TO_CHAR(BOARD_DATE, 'YYYYMMDD') = #{value}
                </when>
                <otherwise>
                    AND (UPPER(board_title) LIKE '%' || UPPER(#{value}) || '%')
                </otherwise>
            </choose>
        </if>
    </where>
     ORDER BY BOARD_DATE DESC  <!-- 최신순 -->
</select>

<!-- 판매금지 제품 공지사항 등록 -->
<insert id="proBoardEnroll" parameterType="Board">
	<selectKey  keyProperty="boardId" resultType="int" order="BEFORE">
		select seq_board.nextval from dual
	</selectKey>
	INSERT INTO board (
	    board_id,
	    board_title,
	    board_date,
	    board_modified_date,
	    board_type,
	    board_status,
	    user_no,
	    board_content
	) VALUES (
	    #{boardId},
	    #{boardTitle},
	    SYSDATE,
	    SYSDATE,
	    '8',
	    'Y',
	    #{userNo},
	    #{boardContent}
	)

</insert>

<select id="proBoardDetail" parameterType="int" resultType="Board">
	select * from board where board_id = #{boardId} and board_type='8' and board_status = 'Y'
</select>


<update id="proBoardDelete">
	update board set board_status ='N' where board_id=#{boardId} and board_type='8'
</update>



</mapper>